<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
	<script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
	<script src="jquery.hotkeys.js"></script>
	<script src="key_status.js"></script>	
	<script type="text/javascript">
		// 初始化
		Number.prototype.clamp = function(min, max) {return Math.min(Math.max(this, min), max);};
		var canvas_width=480;
		var canvas_height=320;
		var canvas_Element=$("<canvas width='"+canvas_width+"' height='"+canvas_height+"'>");
		var canvas=canvas_Element.get(0).getContext("2d");
		canvas_Element.appendTo("body");
		// 游戏循环
		var FPS=30;
		setInterval(function(){
			update();
			draw();
		},1000/FPS);
		
		// 创建player
		var player={
			color:"#00a",
			x:270,
			y:270,
			width:50,
			height:50,
			imgUrl:"2.png",
			draw:function(){
				var img=new Image();
				img.src=this.imgUrl;
				//canvas.fillStyle=this.color;
				canvas.drawImage(img,this.x,this.y,this.width,this.height);
			}
		}

		player.explode = function() {
  			this.active = false;
		};
		
		// 炮弹
		var playerBullets=[];
		function Bullet(I){
			I.active=true;
			I.xVelocity=0;
			I.yVelocity=-I.speed;
			I.width=3;
			I.height=3;
			I.color="#000";

			I.inBounds=function(){
				return I.x>=0&&I.x<=canvas_width&&I.y>=0&&I.y<=canvas_height;
			};

			I.draw=function(){
				canvas.fillStyle=this.color;
				canvas.fillRect(this.x,this.y,this.width,this.height);
			};

			I.update=function(){
				I.x+=I.xVelocity;
				I.y+=I.yVelocity;

				I.active=I.active&&I.inBounds();
			};

			return I;
		}
		// 开火
		player.shoot=function(){
			var bulletPosition=this.midpoint();

			playerBullets.push(Bullet({
				speed:5,
				x:bulletPosition.x,
				y:bulletPosition.y,
			}));
		};

		player.midpoint=function(){
			return{
				x:this.x+this.width/2,
				y:this.y
			};
		};
		// 敌人
		var enemies=[];
		function Enemy(I){
			I=I||{};
			I.active=true;
			I.age=Math.floor(Math.random()*128);
			//I.color="#a2b";
			I.x=canvas_width/4+Math.random()*canvas_width/2;
			I.y=0;
			I.xVelocity=0;
			I.yVelocity=2;
			I.width=32;
			I.height=32;
			I.img= new Image();
			I.img.src="0.png";

			I.inBounds=function(){
				return I.x>=0&&I.x<=canvas_width&&I.y>=0&&I.y<=canvas_height;
			};

			I.explode=function(){
				this.active=false;
			};

			I.draw=function(){
				// canvas.fillStyle=this.color;
				canvas.drawImage(this.img,this.x,this.y,this.width,this.height);
			};

			I.update=function(){
				I.x+=I.xVelocity;
				I.y+=I.yVelocity;

				I.xVelocity=3*Math.sin(I.age*Math.PI/64);

				I.age++;

				I.active=I.active&&I.inBounds();
			};
			return I;
		};
		// 检测碰撞
		function collides(a,b){
			return a.x<b.x+b.width&&a.x+a.width>b.x&&a.y<b.y+b.height&&a.y+a.height>b.y;
		};
		function handleCollisions(){
			playerBullets.forEach(function(bullet){
				enemies.forEach(function(enemy){
					if(collides(bullet,enemy)){
						enemy.explode();
						bullet.active=false;
					}
				});
			});

			enemies.forEach(function(enemy){
				if (collides(enemy,player)) {
					enemy.explode();
					player.explode();
				};
			})
		}
		// 绘制
		function draw(){
			canvas.clearRect(0,0,canvas_width,canvas_height);
			player.draw();
			playerBullets.forEach(function(bullet){
				bullet.draw();  
			});
			enemies.forEach(function(enemy){
				enemy.draw();  
			});
		}
		// 重绘
		function update(){
			if (keydown.left) {
				player.x-=4;
			}
			if (keydown.right) {
				player.x+=4;
			}
			if (keydown.space) {
				player.shoot();
			}
			player.x=player.x.clamp(0,canvas_width-player.width);

			playerBullets.forEach(function(bullet){
				bullet.update();
			});
			playerBullets=playerBullets.filter(function(bullet){
				return bullet.active;
			});

			enemies.forEach(function(enemy){
				enemy.update();  
			});

			enemies=enemies.filter(function(enemy){
				return enemy.active;
			});

			if (Math.random()<0.1) {
				enemies.push(Enemy());
			};

			handleCollisions();
		}
	</script>	
</body>
</html>